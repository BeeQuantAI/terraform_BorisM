name: Uat Deploy
permissions:
  contents: read
  id-token: write
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Confirm version to deploy'
        required: true
        default: 'V0.0.0.0'
jobs:
    deploy-uat:
        environment: uat
        name: deploy by terraform
        runs-on: ubuntu-latest
        steps:
          - name: checkout code
            uses: actions/checkout@v4
          - name: configure AWS credentials
            uses: aws-actions/configure-aws-credentials@v4
            with:
              audience: sts.amazonaws.com
              aws-region: ap-southeast-2
              role-to-assume: ${{ secrets.AWS_ROLE_ARN_BORIS }}
          - name: sts get caller identity
            run: aws sts get-caller-identity
          - name: Login to Amazon ECR
            id: login-ecr
            uses: aws-actions/amazon-ecr-login@v2
          - name: setup terraform
            uses: hashicorp/setup-terraform@v3
          - name: terraform init
            run: terraform init
          - name: terraform plan
            run: terraform plan
          - name: terraform apply
            run: terraform apply -auto-approve -var="image_uri=$ECR_REGISTRY_BORIS/$ECR_REPOSITORY_UAT_BORIS:${{ inputs.version }}" # this will be updated with more envs